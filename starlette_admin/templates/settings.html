{% extends "layout.html" %}

{% block head_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for(__name__ ~ ':statics', path='css/toastr.min.css') }}">
<!-- Bootstrap Icons CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
  .admin-only { display: none; }
  .db-badge { font-size: 0.8rem; margin-left: 0.5rem; color: #6c757d; }

  /* Spinner overlay */
  #loadingSpinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(4px);
    z-index: 1050;
  }

  #loadingSpinner.d-none {
    display: none;
  }

  /* Blur main content when loading */
  #mainContent.blur {
    filter: blur(4px);
    transition: filter 0.2s ease-in;
  }
</style>
{% endblock %}

{% block header %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Settings</h1>
</div>
{% endblock %}

{% block content %}
<div id="mainContent">
  <div class="col-12 col-lg-8">
    <!-- Active Time Range Card -->
    <div class="card shadow-sm mb-4 admin-only" data-admin>
      <div class="card-body">
        <span class="badge rounded-pill bg-primary text-white mb-3">
          <i class="bi bi-gear-fill me-1"></i>Admin Controls
        </span>
        <h3 class="mb-3">Active Time Range</h3>
        <div class="mb-1">
          <label for="activeRange" class="form-label">Select active period (months):</label>
          <select id="activeRange" class="form-select w-auto"></select>
          <small class="text-muted">This determines how far back data is considered "active".</small><br>
          <small class="text-danger">Warning: Changing time range may affect item loading performance.</small>
        </div>
        <button class="btn btn-primary" id="saveSettingsBtn">Save Changes</button>
      </div>
    </div>

    <!-- Linked Accounts Card -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="mb-3">Linked Accounts</h3>
        <p>Select which accounts you’d like to sync quotations &amp; invoices with:</p>
        <div id="accountsList" class="mb-4">
          <p class="text-muted">Loading linked accounts…</p>
        </div>
        <button class="btn btn-primary" id="saveAccountsBtn">Save Synchronization</button>

        <div class="admin-only mt-4" data-admin>
          <hr class="mt-4 mb-3">
          <span class="badge rounded-pill bg-primary text-white mb-3">
            <i class="bi bi-gear-fill me-1"></i>Admin Controls
          </span>
          <div class="d-flex align-items-start">
            <button id="syncAllBtn" class="btn btn-outline-warning me-2">Sync All Accounts</button>
            <button id="stopAllBtn" class="btn btn-outline-danger">Stop All Synchronization</button>
          </div>
          <small class="d-block mt-2 text-muted">
            “Sync All” will clear and re-create every user’s sync settings.<br>
            “Stop All” will disable syncing for every account.
          </small>
        </div>
      </div>
    </div>

<div class="card shadow-sm mt-4">
      <div class="card-body">
        <h3 class="mb-3">Default Home Page</h3>
        <p>Select one of your available menu items:</p>
        <select id="userAccessMenu" class="form-select w-auto">
          <option disabled selected>Loading menu…</option>
        </select>
        <small class="d-block mt-2 mb-2 text-muted">
            This option will set up pre-default loaded home page after your login.<br>
            You can select any page you have access to.
          </small>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" id="saveHomePageBtn">Save Changes</button>
          <button class="btn btn-outline-danger" id="removeHomePageBtn">Remove Home Page</button>
        </div>
      </div>
    </div>

<!-- loading spinner -->
<div id="loadingSpinner" class="d-none">
  <div class="spinner-border" role="status"></div>
  <div class="mt-2 text-muted">
    Loading data, this may take a moment. Please wait and do not refresh the page until the process completes.
  </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script src="{{ url_for(__name__ ~ ':statics', path='js/vendor/toastr.min.js') }}"></script>
<script src="{{ url_for(__name__ ~ ':statics', path='js/settings.js') }}"></script>
<script>

$(document)
  .on('ajaxStart', function() {
    $('#mainContent').addClass('blur');
    $('#loadingSpinner').removeClass('d-none');
  })
  .on('ajaxStop', function() {
    $('#loadingSpinner').addClass('d-none');
    $('#mainContent').removeClass('blur');
  })
  .on('ajaxError', function() {
    $('#loadingSpinner').addClass('d-none');
    $('#mainContent').removeClass('blur');
  });
</script>
{% endblock %}
